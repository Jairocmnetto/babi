<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AtStore - Gestão Inteligente de Estoque</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Bibliotecas para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Biblioteca para scanner de código de barras -->
  <script src="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              600: '#2563eb',
              700: '#1d4ed8',
            },
            danger: {
              600: '#dc2626',
              700: '#b91c1c',
            },
            warning: {
              600: '#d97706',
              700: '#b45309',
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-in',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200 min-h-screen">
  <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <header class="mb-10">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="bg-primary-600 text-white p-3 rounded-xl">
            <i class="fas fa-boxes text-2xl"></i>
          </div>
          <div>
            <h1 class="text-3xl font-bold">AtStore </h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">Gestão inteligente de estoque</p>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
          <button onclick="toggleTheme()" class="flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:inline"></i>
            <span class="hidden sm:inline">Alternar Tema</span>
          </button>
          
          <button onclick="showAddProductModal()" class="flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition">
            <i class="fas fa-plus"></i>
            <span class="hidden sm:inline">Adicionar Produto</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Search and Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 mb-8">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="relative">
          <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
          <input 
            type="text" 
            id="search-input" 
            placeholder="Buscar produtos..." 
            class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700"
            oninput="filterProducts()"
          >
        </div>
        
        <div class="relative">
          <i class="fas fa-filter absolute left-3 top-3 text-gray-400"></i>
          <select 
            id="category-filter" 
            class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700 appearance-none"
            onchange="filterProducts()"
          >
            <option value="">Todas categorias</option>
          </select>
        </div>
        
        <div class="relative">
          <i class="fas fa-sort-amount-down absolute left-3 top-3 text-gray-400"></i>
          <select 
            id="stock-filter" 
            class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700 appearance-none"
            onchange="filterProducts()"
          >
            <option value="">Todos os produtos</option>
            <option value="low">Estoque baixo</option>
            <option value="critical">Estoque crítico</option>
            <option value="out">Fora de estoque</option>
          </select>
        </div>
        
        <div class="flex gap-2">
          <button onclick="showReportModal()" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition w-full justify-center">
            <i class="fas fa-file-pdf"></i>
            <span class="hidden sm:inline">Relatório</span>
          </button>
          <button onclick="showBarcodeScanner()" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition w-full justify-center">
            <i class="fas fa-barcode"></i>
            <span class="hidden sm:inline">Scanner</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 border-l-4 border-primary-600">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Total de Produtos</p>
            <h3 id="total-products" class="text-2xl font-bold">--</h3>
          </div>
          <i class="fas fa-box text-primary-600 text-xl"></i>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 border-l-4 border-green-500">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Em Estoque</p>
            <h3 id="in-stock" class="text-2xl font-bold">--</h3>
          </div>
          <i class="fas fa-check-circle text-green-500 text-xl"></i>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 border-l-4 border-warning-600">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Estoque Baixo</p>
            <h3 id="low-stock" class="text-2xl font-bold">--</h3>
          </div>
          <i class="fas fa-exclamation-triangle text-warning-600 text-xl"></i>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 border-l-4 border-danger-600">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Estoque Crítico</p>
            <h3 id="critical-stock" class="text-2xl font-bold">--</h3>
          </div>
          <i class="fas fa-times-circle text-danger-600 text-xl"></i>
        </div>
      </div>
    </div>

    <!-- Products Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Produto</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Categoria</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Estoque</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Mínimo</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
              <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Movimentação</th>
            </tr>
          </thead>
          <tbody id="products-table" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                <div class="flex justify-center">
                  <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-600"></div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center mt-4">
      <div class="text-sm text-gray-500 dark:text-gray-400">
        Mostrando <span id="showing-from">0</span>-<span id="showing-to">0</span> de <span id="total-items">0</span> produtos
      </div>
      <div class="flex gap-1">
        <button id="prev-page" class="px-3 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 disabled:opacity-50" disabled>
          <i class="fas fa-chevron-left"></i>
        </button>
        <button id="next-page" class="px-3 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 disabled:opacity-50" disabled>
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="add-product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="add-product-modal-content">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Adicionar Produto</h3>
          <button onclick="hideAddProductModal()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form id="product-form" class="space-y-4">
          <div>
            <label for="product-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome do Produto *</label>
            <input 
              type="text" 
              id="product-name" 
              name="produto" 
              required 
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700"
            >
          </div>
          
          <div>
            <label for="product-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categoria *</label>
            <input 
              type="text" 
              id="product-category" 
              name="categoria" 
              required 
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700"
            >
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="product-stock" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Estoque *</label>
              <input 
                type="number" 
                id="product-stock" 
                name="estoque" 
                required 
                min="0" 
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700"
              >
            </div>
            
            <div>
              <label for="product-min" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mínimo *</label>
              <input 
                type="number" 
                id="product-min" 
                name="mínimo" 
                required 
                min="0" 
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700"
              >
            </div>
          </div>
          
          <div>
            <label for="product-image" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">URL da Imagem</label>
            <input 
              type="url" 
              id="product-image" 
              name="imagem" 
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700"
              placeholder="https://example.com/image.jpg"
            >
          </div>
          
          <div>
            <label for="product-action" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">📷 Scanner de Código de Barras</label>
            <div class="flex gap-2">
              <input 
                type="text" 
                id="product-action" 
                name="ação" 
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700"
                placeholder="Código de barras ou link"
              >
              <button type="button" onclick="scanBarcodeForInput('product-action')" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                <i class="fas fa-barcode"></i>
              </button>
            </div>
          </div>
          
          <div class="pt-2">
            <button type="submit" class="w-full bg-primary-600 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition flex items-center justify-center gap-2">
              <i class="fas fa-plus"></i>
              Adicionar Produto
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Report Modal -->
  <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="report-modal-content">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Gerar Relatório</h3>
          <button onclick="hideReportModal()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo de Relatório</label>
            <select id="report-type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700">
              <option value="full">Relatório Completo</option>
              <option value="critical">Estoque Crítico</option>
              <option value="low">Estoque Baixo</option>
              <option value="category">Por Categoria</option>
            </select>
          </div>
          
          <div id="category-select-container" class="hidden">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categoria</label>
            <select id="report-category" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700">
              <!-- Categories will be populated by JavaScript -->
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Formato</label>
            <div class="grid grid-cols-3 gap-2">
              <button onclick="generateReport('pdf')" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
              <button onclick="generateReport('html')" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-file-code"></i> HTML
              </button>
              <button onclick="generateReport('text')" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-file-alt"></i> Texto
              </button>
            </div>
          </div>
          
          <div class="pt-4">
            <button onclick="shareReport()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
              <i class="fas fa-share-alt"></i> Compartilhar Relatório
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="share-modal-content">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Compartilhar Relatório</h3>
          <button onclick="hideShareModal()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Método</label>
            <div class="grid grid-cols-2 gap-2">
              <button onclick="shareViaWhatsApp()" class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center justify-center gap-2">
                <i class="fab fa-whatsapp"></i> WhatsApp
              </button>
              <button onclick="shareViaEmail()" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center justify-center gap-2">
                <i class="fas fa-envelope"></i> E-mail
              </button>
            </div>
          </div>
          
          <div id="email-fields" class="hidden space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Destinatário</label>
              <input type="email" id="email-to" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700" placeholder="email@exemplo.com">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Assunto</label>
              <input type="text" id="email-subject" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700" placeholder="Relatório de Estoque">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mensagem</label>
              <textarea id="email-body" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent dark:bg-gray-700" placeholder="Segue o relatório de estoque..."></textarea>
            </div>
            <button onclick="sendEmail()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
              Enviar E-mail
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barcode Scanner Modal -->
  <div id="barcode-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="barcode-modal-content">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Scanner de Código de Barras</h3>
          <button onclick="hideBarcodeScanner()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="space-y-4">
          <div id="barcode-scanner-container" class="w-full h-64 bg-black rounded-lg overflow-hidden relative">
            <video id="barcode-video" width="100%" height="100%" class="object-cover"></video>
            <div class="absolute inset-0 border-4 border-green-500 pointer-events-none"></div>
          </div>
          
          <div class="text-center">
            <p class="text-sm text-gray-500 dark:text-gray-400">Posicione o código de barras dentro da área destacada</p>
          </div>
          
          <div class="flex gap-2">
            <button onclick="startBarcodeScanner()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition">
              <i class="fas fa-play"></i> Iniciar
            </button>
            <button onclick="stopBarcodeScanner()" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition">
              <i class="fas fa-stop"></i> Parar
            </button>
          </div>
          
          <div id="barcode-result" class="hidden p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
            <p class="font-medium">Código lido:</p>
            <p id="barcode-value" class="font-mono"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stock Analysis Modal -->
  <div id="analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-2xl transform transition-all duration-300 scale-95 opacity-0" id="analysis-modal-content">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Análise de Estoque</h3>
          <button onclick="hideAnalysisModal()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
              <h4 class="font-bold text-blue-800 dark:text-blue-200 mb-2">Itens com maior estoque</h4>
              <ul id="top-stock-items" class="space-y-1">
                <!-- Filled by JavaScript -->
              </ul>
            </div>
            
            <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg">
              <h4 class="font-bold text-yellow-800 dark:text-yellow-200 mb-2">Itens com estoque baixo</h4>
              <ul id="low-stock-items" class="space-y-1">
                <!-- Filled by JavaScript -->
              </ul>
            </div>
            
            <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg">
              <h4 class="font-bold text-red-800 dark:text-red-200 mb-2">Itens críticos</h4>
              <ul id="critical-stock-items" class="space-y-1">
                <!-- Filled by JavaScript -->
              </ul>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
            <h4 class="font-bold mb-3">Distribuição por Categoria</h4>
            <div id="category-chart" class="h-64">
              <!-- Chart will be rendered here -->
              <p class="text-center text-gray-500 py-20">Gráfico de distribuição por categoria</p>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
            <h4 class="font-bold mb-3">Recomendações</h4>
            <ul id="recommendations" class="list-disc pl-5 space-y-1">
              <!-- Filled by JavaScript -->
            </ul>
          </div>
          
          <div class="flex justify-end">
            <button onclick="generateReport('pdf', true)" class="bg-primary-600 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
              <i class="fas fa-download"></i> Exportar Análise
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg hidden transform translate-y-4 opacity-0 transition-all duration-300 z-50">
    <div class="flex items-start gap-3 max-w-sm">
      <i id="notification-icon" class="fas fa-check mt-1"></i>
      <div>
        <h4 id="notification-title" class="font-bold"></h4>
        <p id="notification-message" class="text-sm"></p>
      </div>
      <button onclick="hideNotification()" class="ml-4 text-gray-400 hover:text-gray-500">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxih8mATdN2PWg92GGMVe4F2cGe-u84G3PuGeISwN_83DygwMrhu18pLP5fYckazVRM/exec';
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let categories = new Set();
    let scannerActive = false;

    // DOM Elements
    const productsTable = document.getElementById('products-table');
    const searchInput = document.getElementById('search-input');
    const categoryFilter = document.getElementById('category-filter');
    const stockFilter = document.getElementById('stock-filter');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const showingFrom = document.getElementById('showing-from');
    const showingTo = document.getElementById('showing-to');
    const totalItems = document.getElementById('total-items');
    const totalProductsEl = document.getElementById('total-products');
    const inStockEl = document.getElementById('in-stock');
    const lowStockEl = document.getElementById('low-stock');
    const criticalStockEl = document.getElementById('critical-stock');

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      loadProducts();
      setupEventListeners();
    });

    // Event listeners
    function setupEventListeners() {
      document.getElementById('product-form').addEventListener('submit', addProduct);
      prevPageBtn.addEventListener('click', () => changePage(-1));
      nextPageBtn.addEventListener('click', () => changePage(1));
      
      // Report type change listener
      document.getElementById('report-type').addEventListener('change', function() {
        document.getElementById('category-select-container').classList.toggle('hidden', this.value !== 'category');
      });
    }

    // Load products from API
    async function loadProducts() {
      try {
        showLoading();
        const response = await fetch(API_URL);
        allProducts = await response.json();
        
        // Extract categories
        categories = new Set(allProducts.map(p => p.categoria).filter(Boolean));
        updateCategoryFilter();
        
        // Update report category filter
        const reportCategorySelect = document.getElementById('report-category');
        reportCategorySelect.innerHTML = Array.from(categories).map(cat => 
          `<option value="${cat}">${cat}</option>`
        ).join('');
        
        filterProducts();
        updateStats();
      } catch (error) {
        showError('Erro ao carregar produtos');
        console.error('Error loading products:', error);
      }
    }

    // Update category filter dropdown
    function updateCategoryFilter() {
      categoryFilter.innerHTML = `
        <option value="">Todas categorias</option>
        ${Array.from(categories).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
      `;
    }

    // Filter products based on search and filters
    function filterProducts() {
      const searchTerm = searchInput.value.toLowerCase();
      const selectedCategory = categoryFilter.value;
      const stockStatus = stockFilter.value;
      
      filteredProducts = allProducts.filter(product => {
        // Search filter
        const matchesSearch = 
          product.produto?.toLowerCase().includes(searchTerm) || 
          product.categoria?.toLowerCase().includes(searchTerm);
        
        // Category filter
        const matchesCategory = !selectedCategory || product.categoria === selectedCategory;
        
        // Stock status filter
        let matchesStock = true;
        if (stockStatus === 'low') {
          matchesStock = product.estoque > 0 && product.estoque <= product.mínimo;
        } else if (stockStatus === 'critical') {
          matchesStock = product.estoque <= 0;
        } else if (stockStatus === 'out') {
          matchesStock = product.estoque <= product.mínimo;
        }
        
        return matchesSearch && matchesCategory && matchesStock;
      });
      
      currentPage = 1;
      renderProducts();
      updatePagination();
    }

    // Render products table
    function renderProducts() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedProducts = filteredProducts.slice(startIndex, endIndex);
      
      if (paginatedProducts.length === 0) {
        productsTable.innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
              Nenhum produto encontrado
            </td>
          </tr>
        `;
        return;
      }
      
      productsTable.innerHTML = paginatedProducts.map(product => {
        const stockStatus = getStockStatus(product.estoque, product.mínimo);
        const statusClass = {
          'good': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
          'low': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
          'critical': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
        }[stockStatus];
        
        const statusText = {
          'good': 'Em Estoque',
          'low': 'Estoque Baixo',
          'critical': 'Estoque Crítico'
        }[stockStatus];
        
        return `
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <img class="h-10 w-10 rounded-full object-cover" src="${product.imagem || 'https://via.placeholder.com/150'}" alt="${product.produto}">
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium">${product.produto || '--'}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm">${product.categoria || '--'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm">${product.estoque || 0}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm">${product.mínimo || 0}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <div class="flex justify-end gap-2">
                <button onclick="adjustStock('${product.produto}', 'out')" class="text-red-600 hover:text-red-900 dark:hover:text-red-400" title="Saída">
                  <i class="fas fa-arrow-down"></i>
                </button>
                <button onclick="adjustStock('${product.produto}', 'in')" class="text-green-600 hover:text-green-900 dark:hover:text-green-400" title="Entrada">
                  <i class="fas fa-arrow-up"></i>
                </button>
                <button onclick="editProduct('${product.produto}')" class="text-blue-600 hover:text-blue-900 dark:hover:text-blue-400">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteProduct('${product.produto}')" class="text-red-600 hover:text-red-900 dark:hover:text-red-400">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Adjust stock (in/out)
    function adjustStock(productName, direction) {
      const product = allProducts.find(p => p.produto === productName);
      if (!product) return;
      
      const amount = prompt(`Quantidade para ${direction === 'in' ? 'entrada' : 'saída'}:`, "1");
      if (!amount || isNaN(amount)) return;
      
      const change = direction === 'in' ? +amount : -amount;
      product.estoque = Math.max(0, product.estoque + change);
      
      // In a real app, you would send this update to your API
      showNotification('Estoque ajustado', `Estoque de ${productName} atualizado para ${product.estoque}`, 'success');
      filterProducts();
      updateStats();
    }

    // Get stock status
    function getStockStatus(stock, min) {
      if (stock <= 0) return 'critical';
      if (stock <= min) return 'low';
      return 'good';
    }

    // Update pagination controls
    function updatePagination() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      
      showingFrom.textContent = ((currentPage - 1) * itemsPerPage) + 1;
      showingTo.textContent = Math.min(currentPage * itemsPerPage, filteredProducts.length);
      totalItems.textContent = filteredProducts.length;
      
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
    }

    // Change page
    function changePage(direction) {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      const newPage = currentPage + direction;
      
      if (newPage > 0 && newPage <= totalPages) {
        currentPage = newPage;
        renderProducts();
        updatePagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // Update stats
    function updateStats() {
      totalProductsEl.textContent = allProducts.length;
      
      const inStock = allProducts.filter(p => p.estoque > p.mínimo).length;
      const lowStock = allProducts.filter(p => p.estoque > 0 && p.estoque <= p.mínimo).length;
      const criticalStock = allProducts.filter(p => p.estoque <= 0).length;
      
      inStockEl.textContent = inStock;
      lowStockEl.textContent = lowStock;
      criticalStockEl.textContent = criticalStock;
    }

    // Add new product
    async function addProduct(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      // Convert numbers
      data.estoque = Number(data.estoque);
      data.mínimo = Number(data.mínimo);
      
      try {
        showLoading();
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'sucesso') {
          showNotification('Sucesso', 'Produto adicionado com sucesso!', 'success');
          hideAddProductModal();
          form.reset();
          await loadProducts();
        } else {
          throw new Error(result.mensagem || 'Erro ao adicionar produto');
        }
      } catch (error) {
        showNotification('Erro', error.message, 'error');
        console.error('Error adding product:', error);
      }
    }

    // Edit product (placeholder - would need API support)
    function editProduct(productName) {
      const product = allProducts.find(p => p.produto === productName);
      if (!product) return;
      
      // Fill the form with product data
      document.getElementById('product-name').value = product.produto || '';
      document.getElementById('product-category').value = product.categoria || '';
      document.getElementById('product-stock').value = product.estoque || 0;
      document.getElementById('product-min').value = product.mínimo || 0;
      document.getElementById('product-image').value = product.imagem || '';
      document.getElementById('product-action').value = product.ação || '';
      
      // Change the form to edit mode
      const form = document.getElementById('product-form');
      form.dataset.editMode = 'true';
      form.dataset.productName = productName;
      
      // Change the button text
      const submitButton = form.querySelector('button[type="submit"]');
      submitButton.innerHTML = '<i class="fas fa-save"></i> Salvar Alterações';
      
      showAddProductModal();
    }

    // Delete product (placeholder - would need API support)
    function deleteProduct(productName) {
      if (confirm(`Tem certeza que deseja excluir "${productName}"?`)) {
        // In a real implementation, you would send a DELETE request to your API
        allProducts = allProducts.filter(p => p.produto !== productName);
        filterProducts();
        updateStats();
        showNotification('Sucesso', `Produto "${productName}" removido`, 'success');
      }
    }

    // Report functions
    function showReportModal() {
      const modal = document.getElementById('report-modal');
      const content = document.getElementById('report-modal-content');
      
      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    function hideReportModal() {
      const modal = document.getElementById('report-modal');
      const content = document.getElementById('report-modal-content');
      
      content.classList.remove('scale-100', 'opacity-100');
      content.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }

    function generateReport(format, isAnalysis = false) {
      const reportType = document.getElementById('report-type').value;
      const category = document.getElementById('report-category').value;
      
      let productsToReport = [];
      
      switch(reportType) {
        case 'full':
          productsToReport = allProducts;
          break;
        case 'critical':
          productsToReport = allProducts.filter(p => p.estoque <= 0);
          break;
        case 'low':
          productsToReport = allProducts.filter(p => p.estoque > 0 && p.estoque <= p.mínimo);
          break;
        case 'category':
          productsToReport = allProducts.filter(p => p.categoria === category);
          break;
      }
      
      if (isAnalysis) {
        productsToReport = allProducts; // For analysis, always use all products
      }
      
      switch(format) {
        case 'pdf':
          generatePDFReport(productsToReport, isAnalysis);
          break;
        case 'html':
          generateHTMLReport(productsToReport, isAnalysis);
          break;
        case 'text':
          generateTextReport(productsToReport, isAnalysis);
          break;
      }
      
      if (!isAnalysis) {
        hideReportModal();
      }
    }

    function generatePDFReport(products, isAnalysis = false) {
      showNotification('Gerando PDF', 'O relatório está sendo gerado, aguarde...', 'info');
      
      // Use jsPDF with autoTable plugin
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Title
      doc.setFontSize(18);
      doc.setTextColor(40);
      doc.text(isAnalysis ? 'Relatório de Análise de Estoque' : 'Relatório de Estoque', 14, 20);
      
      // Date
      doc.setFontSize(10);
      doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 28);
      
      // Summary stats
      doc.setFontSize(12);
      doc.text(`Total de produtos: ${allProducts.length}`, 14, 36);
      doc.text(`Produtos em estoque: ${allProducts.filter(p => p.estoque > p.mínimo).length}`, 14, 42);
      doc.text(`Produtos com estoque baixo: ${allProducts.filter(p => p.estoque > 0 && p.estoque <= p.mínimo).length}`, 14, 48);
      doc.text(`Produtos críticos: ${allProducts.filter(p => p.estoque <= 0).length}`, 14, 54);
      
      if (isAnalysis) {
        // Add analysis content
        doc.addPage();
        doc.setFontSize(16);
        doc.text('Análise Detalhada', 14, 20);
        
        // Top products
        doc.setFontSize(12);
        doc.text('Produtos com maior estoque:', 14, 30);
        const topProducts = [...allProducts].sort((a, b) => b.estoque - a.estoque).slice(0, 5);
        topProducts.forEach((p, i) => {
          doc.text(`${i+1}. ${p.produto} - ${p.estoque} unidades`, 20, 38 + i*8);
        });
        
        // Critical products
        doc.text('Produtos críticos:', 14, 80);
        const criticalProducts = allProducts.filter(p => p.estoque <= 0);
        criticalProducts.forEach((p, i) => {
          if (i < 5) doc.text(`${i+1}. ${p.produto}`, 20, 88 + i*8);
        });
        
        // Recommendations
        doc.addPage();
        doc.setFontSize(16);
        doc.text('Recomendações', 14, 20);
        
        const recommendations = generateRecommendations();
        recommendations.forEach((rec, i) => {
          doc.setFontSize(10);
          doc.text(`• ${rec}`, 14, 30 + i*8);
        });
      } else {
        // Product table
        doc.autoTable({
          startY: 60,
          head: [['Produto', 'Categoria', 'Estoque', 'Mínimo', 'Status']],
          body: products.map(p => [
            p.produto,
            p.categoria,
            p.estoque,
            p.mínimo,
            getStockStatusText(p.estoque, p.mínimo)
          ]),
          theme: 'grid',
          headStyles: {
            fillColor: [41, 99, 235],
            textColor: 255
          },
          alternateRowStyles: {
            fillColor: [240, 240, 240]
          },
          margin: { top: 10 }
        });
      }
      
      // Save the PDF
      doc.save(isAnalysis ? 'analise_estoque.pdf' : 'relatorio_estoque.pdf');
      showNotification('PDF Gerado', 'O relatório foi baixado com sucesso', 'success');
    }

    function generateHTMLReport(products) {
      let html = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Relatório de Estoque</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1 { color: #2563eb; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #2563eb; color: white; }
            tr:nth-child(even) { background-color: #f2f2f2; }
            .critical { background-color: #ffdddd; }
            .low { background-color: #fff3cd; }
          </style>
        </head>
        <body>
          <h1>Relatório de Estoque</h1>
          <p>Gerado em: ${new Date().toLocaleString()}</p>
          
          <h2>Resumo</h2>
          <ul>
            <li>Total de produtos: ${allProducts.length}</li>
            <li>Produtos em estoque: ${allProducts.filter(p => p.estoque > p.mínimo).length}</li>
            <li>Produtos com estoque baixo: ${allProducts.filter(p => p.estoque > 0 && p.estoque <= p.mínimo).length}</li>
            <li>Produtos críticos: ${allProducts.filter(p => p.estoque <= 0).length}</li>
          </ul>
          
          <h2>Produtos</h2>
          <table>
            <tr>
              <th>Produto</th>
              <th>Categoria</th>
              <th>Estoque</th>
              <th>Mínimo</th>
              <th>Status</th>
            </tr>
      `;
      
      products.forEach(p => {
        const status = getStockStatusText(p.estoque, p.mínimo);
        const rowClass = p.estoque <= 0 ? 'critical' : (p.estoque <= p.mínimo ? 'low' : '');
        
        html += `
          <tr class="${rowClass}">
            <td>${p.produto}</td>
            <td>${p.categoria}</td>
            <td>${p.estoque}</td>
            <td>${p.mínimo}</td>
            <td>${status}</td>
          </tr>
        `;
      });
      
      html += `
          </table>
        </body>
        </html>
      `;
      
      // Open in new window
      const win = window.open('', '_blank');
      win.document.write(html);
      showNotification('HTML Gerado', 'O relatório foi aberto em uma nova aba', 'success');
    }

    function generateTextReport(products) {
      let text = `Relatório de Estoque\n`;
      text += `Gerado em: ${new Date().toLocaleString()}\n\n`;
      
      text += `=== Resumo ===\n`;
      text += `Total de produtos: ${allProducts.length}\n`;
      text += `Produtos em estoque: ${allProducts.filter(p => p.estoque > p.mínimo).length}\n`;
      text += `Produtos com estoque baixo: ${allProducts.filter(p => p.estoque > 0 && p.estoque <= p.mínimo).length}\n`;
      text += `Produtos críticos: ${allProducts.filter(p => p.estoque <= 0).length}\n\n`;
      
      text += `=== Produtos ===\n`;
      products.forEach(p => {
        text += `${p.produto} | ${p.categoria} | Estoque: ${p.estoque} | Mín: ${p.mínimo} | ${getStockStatusText(p.estoque, p.mínimo)}\n`;
      });
      
      // Create download
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'relatorio_estoque.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      showNotification('Texto Gerado', 'O relatório foi baixado como arquivo de texto', 'success');
    }

    function getStockStatusText(stock, min) {
      if (stock <= 0) return 'CRÍTICO (sem estoque)';
      if (stock <= min) return 'BAIXO (abaixo do mínimo)';
      return 'NORMAL';
    }

    // Share functions
    function shareReport() {
      showShareModal();
    }

    function showShareModal() {
      const modal = document.getElementById('share-modal');
      const content = document.getElementById('share-modal-content');
      
      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    function hideShareModal() {
      const modal = document.getElementById('share-modal');
      const content = document.getElementById('share-modal-content');
      
      content.classList.remove('scale-100', 'opacity-100');
      content.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
        modal.classList.add('hidden');
        document.getElementById('email-fields').classList.add('hidden');
      }, 300);
    }

    function shareViaWhatsApp() {
      const reportType = document.getElementById('report-type').value;
      let message = `*Relatório de Estoque*\n\n`;
      
      message += `📅 Data: ${new Date().toLocaleString()}\n`;
      message += `📊 Tipo: ${getReportTypeName(reportType)}\n\n`;
      
      message += `📦 *Resumo*\n`;
      message += `• Total de produtos: ${allProducts.length}\n`;
      message += `• Em estoque: ${allProducts.filter(p => p.estoque > p.mínimo).length}\n`;
      message += `• Estoque baixo: ${allProducts.filter(p => p.estoque > 0 && p.estoque <= p.mínimo).length}\n`;
      message += `• Críticos: ${allProducts.filter(p => p.estoque <= 0).length}\n\n`;
      
      message += `Para ver o relatório completo, acesse o sistema.`;
      
      const encodedMessage = encodeURIComponent(message);
      window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    }

    function getReportTypeName(type) {
      const types = {
        'full': 'Completo',
        'critical': 'Estoque Crítico',
        'low': 'Estoque Baixo',
        'category': 'Por Categoria'
      };
      return types[type] || type;
    }

    function shareViaEmail() {
      document.getElementById('email-fields').classList.remove('hidden');
      
      // Pre-fill email details
      const reportType = document.getElementById('report-type').value;
      document.getElementById('email-subject').value = `Relatório de Estoque - ${getReportTypeName(reportType)}`;
      
      let body = `Prezado,\n\nSegue o relatório de estoque solicitado.\n\n`;
      body += `Tipo: ${getReportTypeName(reportType)}\n`;
      body += `Data: ${new Date().toLocaleString()}\n\n`;
      body += `Resumo:\n`;
      body += `- Total de produtos: ${allProducts.length}\n`;
      body += `- Produtos em estoque: ${allProducts.filter(p => p.estoque > p.mínimo).length}\n`;
      body += `- Produtos com estoque baixo: ${allProducts.filter(p => p.estoque > 0 && p.estoque <= p.mínimo).length}\n`;
      body += `- Produtos críticos: ${allProducts.filter(p => p.estoque <= 0).length}\n\n`;
      body += `Atenciosamente,\n`;
      
      document.getElementById('email-body').value = body;
    }

    function sendEmail() {
      const to = document.getElementById('email-to').value;
      const subject = document.getElementById('email-subject').value;
      const body = document.getElementById('email-body').value;
      
      if (!to) {
        showNotification('Erro', 'Por favor, insira um destinatário', 'error');
        return;
      }
      
      // In a real app, you would send this to your backend to send the email
      // For now, we'll just open the default mail client
      window.open(`mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
      
      hideShareModal();
      showNotification('E-mail pronto', 'Seu cliente de e-mail será aberto com a mensagem', 'success');
    }

    // Barcode scanner functions
    function showBarcodeScanner() {
      const modal = document.getElementById('barcode-modal');
      const content = document.getElementById('barcode-modal-content');
      
      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
      }, 10);
      
      // Initialize scanner but don't start yet
      initBarcodeScanner();
    }

    function hideBarcodeScanner() {
      stopBarcodeScanner();
      
      const modal = document.getElementById('barcode-modal');
      const content = document.getElementById('barcode-modal-content');
      
      content.classList.remove('scale-100', 'opacity-100');
      content.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
        modal.classList.add('hidden');
        document.getElementById('barcode-result').classList.add('hidden');
      }, 300);
    }

    function scanBarcodeForInput(inputId) {
      const inputField = document.getElementById(inputId);
      
      function onBarcodeScanned(code) {
        inputField.value = code;
        hideBarcodeScanner();
      }
      
      // Set the callback for when a barcode is scanned
      window.barcodeScannedCallback = onBarcodeScanned;
      
      showBarcodeScanner();
      startBarcodeScanner();
    }

    function initBarcodeScanner() {
      // Configuration for QuaggaJS
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#barcode-video'),
          constraints: {
            facingMode: "environment" // Use the rear camera
          },
        },
        decoder: {
          readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader"]
        },
      }, function(err) {
        if (err) {
          console.error("Failed to initialize scanner", err);
          showNotification('Erro', 'Falha ao iniciar o scanner', 'error');
          return;
        }
        
        // Set up detection callback
        Quagga.onDetected(function(result) {
          if (result.codeResult) {
            const code = result.codeResult.code;
            document.getElementById('barcode-value').textContent = code;
            document.getElementById('barcode-result').classList.remove('hidden');
            
            if (window.barcodeScannedCallback) {
              window.barcodeScannedCallback(code);
            }
            
            // Stop after successful scan
            stopBarcodeScanner();
          }
        });
      });
    }

    function startBarcodeScanner() {
      if (!scannerActive) {
        Quagga.start();
        scannerActive = true;
      }
    }

    function stopBarcodeScanner() {
      if (scannerActive) {
        Quagga.stop();
        scannerActive = false;
      }
    }

    // Stock analysis functions
    function showAnalysisModal() {
      const modal = document.getElementById('analysis-modal');
      const content = document.getElementById('analysis-modal-content');
      
      // Populate analysis data
      populateAnalysisData();
      
      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    function hideAnalysisModal() {
      const modal = document.getElementById('analysis-modal');
      const content = document.getElementById('analysis-modal-content');
      
      content.classList.remove('scale-100', 'opacity-100');
      content.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }

    function populateAnalysisData() {
      // Top stock items
      const topStockItems = [...allProducts].sort((a, b) => b.estoque - a.estoque).slice(0, 5);
      document.getElementById('top-stock-items').innerHTML = topStockItems.map(p => 
        `<li class="truncate">${p.produto} <span class="font-bold">(${p.estoque})</span></li>`
      ).join('');
      
      // Low stock items
      const lowStockItems = allProducts.filter(p => p.estoque > 0 && p.estoque <= p.mínimo).slice(0, 5);
      document.getElementById('low-stock-items').innerHTML = lowStockItems.map(p => 
        `<li class="truncate">${p.produto} <span class="font-bold">(${p.estoque}/${p.mínimo})</span></li>`
      ).join('');
      
      // Critical stock items
      const criticalStockItems = allProducts.filter(p => p.estoque <= 0).slice(0, 5);
      document.getElementById('critical-stock-items').innerHTML = criticalStockItems.map(p => 
        `<li class="truncate">${p.produto} <span class="font-bold">(ESGOTADO)</span></li>`
      ).join('');
      
      // Recommendations
      const recommendations = generateRecommendations();
      document.getElementById('recommendations').innerHTML = recommendations.map(r => 
        `<li>${r}</li>`
      ).join('');
    }

    function generateRecommendations() {
      const recommendations = [];
      const criticalCount = allProducts.filter(p => p.estoque <= 0).length;
      const lowCount = allProducts.filter(p => p.estoque > 0 && p.estoque <= p.mínimo).length;
      
      if (criticalCount > 0) {
        recommendations.push(`Priorize a reposição dos ${criticalCount} itens esgotados`);
      }
      
      if (lowCount > 0) {
        recommendations.push(`Monitore os ${lowCount} itens com estoque baixo`);
      }
      
      // Check for categories with mostly low stock
      const categoriesWithLowStock = {};
      allProducts.forEach(p => {
        if (p.estoque <= p.mínimo && p.categoria) {
          categoriesWithLowStock[p.categoria] = (categoriesWithLowStock[p.categoria] || 0) + 1;
        }
      });
      
      for (const [category, count] of Object.entries(categoriesWithLowStock)) {
        if (count >= 3) { // Arbitrary threshold
          recommendations.push(`A categoria "${category}" tem ${count} itens com estoque baixo ou crítico`);
        }
      }
      
      if (recommendations.length === 0) {
        recommendations.push('Estoque em situação normal, nenhuma ação urgente necessária');
      }
      
      return recommendations;
    }

    // Modal functions
    function showAddProductModal() {
      const modal = document.getElementById('add-product-modal');
      const content = document.getElementById('add-product-modal-content');
      
      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    function hideAddProductModal() {
      const modal = document.getElementById('add-product-modal');
      const content = document.getElementById('add-product-modal-content');
      
      content.classList.remove('scale-100', 'opacity-100');
      content.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }

    // Notification functions
    function showNotification(title, message, type = 'info') {
      const notification = document.getElementById('notification');
      const icon = document.getElementById('notification-icon');
      const notificationTitle = document.getElementById('notification-title');
      const notificationMessage = document.getElementById('notification-message');
      
      // Set notification style based on type
      const typeClasses = {
        'success': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
        'error': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
        'warning': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
        'info': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
      };
      
      const typeIcons = {
        'success': 'fa-check-circle',
        'error': 'fa-times-circle',
        'warning': 'fa-exclamation-triangle',
        'info': 'fa-info-circle'
      };
      
      notification.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg ${typeClasses[type]} transform translate-y-4 opacity-0 transition-all duration-300 z-50`;
      icon.className = `fas ${typeIcons[type]} mt-1`;
      
      notificationTitle.textContent = title;
      notificationMessage.textContent = message;
      
      notification.classList.remove('hidden');
      setTimeout(() => {
        notification.classList.remove('translate-y-4', 'opacity-0');
        notification.classList.add('translate-y-0', 'opacity-100');
      }, 10);
      
      // Auto-hide after 5 seconds
      setTimeout(hideNotification, 5000);
    }

    function hideNotification() {
      const notification = document.getElementById('notification');
      notification.classList.add('translate-y-4', 'opacity-0');
      setTimeout(() => {
        notification.classList.add('hidden');
      }, 300);
    }

    // Loading state
    function showLoading() {
      productsTable.innerHTML = `
        <tr>
          <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
            <div class="flex justify-center">
              <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-600"></div>
            </div>
          </td>
        </tr>
      `;
    }

    function showError(message) {
      productsTable.innerHTML = `
        <tr>
          <td colspan="6" class="px-6 py-4 text-center text-red-500">
            <div class="flex items-center justify-center gap-2">
              <i class="fas fa-exclamation-circle"></i>
              ${message}
            </div>
          </td>
        </tr>
      `;
    }

    // Toggle dark/light theme
    function toggleTheme() {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
    }

    // Check for saved theme preference
    if (localStorage.getItem('darkMode') === 'true') {
      document.documentElement.classList.add('dark');
    }
  </script>
</body>
</html>